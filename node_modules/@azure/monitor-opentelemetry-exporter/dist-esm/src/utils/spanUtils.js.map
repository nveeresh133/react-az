{"version":3,"file":"spanUtils.js","sourceRoot":"","sources":["../../../src/utils/spanUtils.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT license.\n\nimport { URL } from \"url\";\nimport { ReadableSpan, TimedEvent } from \"@opentelemetry/sdk-trace-base\";\nimport { hrTimeToMilliseconds } from \"@opentelemetry/core\";\nimport { diag, SpanKind, SpanStatusCode, Link, Attributes } from \"@opentelemetry/api\";\nimport {\n  DBSYSTEMVALUES_MONGODB,\n  DBSYSTEMVALUES_MYSQL,\n  DBSYSTEMVALUES_POSTGRESQL,\n  DBSYSTEMVALUES_REDIS,\n  SEMATTRS_DB_NAME,\n  SEMATTRS_DB_OPERATION,\n  SEMATTRS_DB_STATEMENT,\n  SEMATTRS_DB_SYSTEM,\n  SEMATTRS_ENDUSER_ID,\n  SEMATTRS_EXCEPTION_ESCAPED,\n  SEMATTRS_EXCEPTION_MESSAGE,\n  SEMATTRS_EXCEPTION_STACKTRACE,\n  SEMATTRS_EXCEPTION_TYPE,\n  SEMATTRS_HTTP_CLIENT_IP,\n  SEMATTRS_HTTP_HOST,\n  SEMATTRS_HTTP_METHOD,\n  SEMATTRS_HTTP_ROUTE,\n  SEMATTRS_HTTP_STATUS_CODE,\n  SEMATTRS_HTTP_URL,\n  SEMATTRS_HTTP_USER_AGENT,\n  SEMATTRS_NET_PEER_IP,\n  SEMATTRS_NET_PEER_NAME,\n  SEMATTRS_PEER_SERVICE,\n  SEMATTRS_RPC_GRPC_STATUS_CODE,\n  SEMATTRS_RPC_SYSTEM,\n} from \"@opentelemetry/semantic-conventions\";\n\nimport {\n  createTagsFromResource,\n  getDependencyTarget,\n  getUrl,\n  hrTimeToDate,\n  isSqlDB,\n} from \"./common\";\nimport { Tags, Properties, MSLink, Measurements } from \"../types\";\nimport { parseEventHubSpan } from \"./eventhub\";\nimport { AzureMonitorSampleRate, DependencyTypes, MS_LINKS } from \"./constants/applicationinsights\";\nimport { AzNamespace, MicrosoftEventHub } from \"./constants/span/azAttributes\";\nimport {\n  TelemetryExceptionData,\n  MessageData,\n  RemoteDependencyData,\n  RequestData,\n  TelemetryItem as Envelope,\n  KnownContextTagKeys,\n  TelemetryExceptionDetails,\n} from \"../generated\";\nimport { msToTimeSpan } from \"./breezeUtils\";\n\nfunction createTagsFromSpan(span: ReadableSpan): Tags {\n  const tags: Tags = createTagsFromResource(span.resource);\n  tags[KnownContextTagKeys.AiOperationId] = span.spanContext().traceId;\n  if (span.parentSpanId) {\n    tags[KnownContextTagKeys.AiOperationParentId] = span.parentSpanId;\n  }\n  const endUserId = span.attributes[SEMATTRS_ENDUSER_ID];\n  if (endUserId) {\n    tags[KnownContextTagKeys.AiUserId] = String(endUserId);\n  }\n  const httpUserAgent = span.attributes[SEMATTRS_HTTP_USER_AGENT];\n  if (httpUserAgent) {\n    // TODO: Not exposed in Swagger, need to update def\n    tags[\"ai.user.userAgent\"] = String(httpUserAgent);\n  }\n  if (span.kind === SpanKind.SERVER) {\n    const httpMethod = span.attributes[SEMATTRS_HTTP_METHOD];\n    const httpClientIp = span.attributes[SEMATTRS_HTTP_CLIENT_IP];\n    const netPeerIp = span.attributes[SEMATTRS_NET_PEER_IP];\n    if (httpMethod) {\n      const httpRoute = span.attributes[SEMATTRS_HTTP_ROUTE];\n      const httpUrl = span.attributes[SEMATTRS_HTTP_URL];\n      tags[KnownContextTagKeys.AiOperationName] = span.name; // Default\n      if (httpRoute) {\n        tags[KnownContextTagKeys.AiOperationName] = `${httpMethod as string} ${\n          httpRoute as string\n        }`;\n      } else if (httpUrl) {\n        try {\n          const url = new URL(String(httpUrl));\n          tags[KnownContextTagKeys.AiOperationName] = `${httpMethod} ${url.pathname}`;\n        } catch {\n          /* no-op */\n        }\n      }\n      if (httpClientIp) {\n        tags[KnownContextTagKeys.AiLocationIp] = String(httpClientIp);\n      } else if (netPeerIp) {\n        tags[KnownContextTagKeys.AiLocationIp] = String(netPeerIp);\n      }\n    } else {\n      tags[KnownContextTagKeys.AiOperationName] = span.name;\n      if (netPeerIp) {\n        tags[KnownContextTagKeys.AiLocationIp] = String(netPeerIp);\n      }\n    }\n  }\n  // TODO: Operation Name and Location IP TBD for non server spans\n\n  return tags;\n}\n\nfunction createPropertiesFromSpanAttributes(attributes?: Attributes): {\n  [propertyName: string]: string;\n} {\n  const properties: { [propertyName: string]: string } = {};\n  if (attributes) {\n    for (const key of Object.keys(attributes)) {\n      // Avoid duplication ignoring fields already mapped.\n      if (\n        !(\n          key.startsWith(\"_MS.\") ||\n          key.startsWith(\"microsoft.\") ||\n          key === SEMATTRS_NET_PEER_IP ||\n          key === SEMATTRS_NET_PEER_NAME ||\n          key === SEMATTRS_PEER_SERVICE ||\n          key === SEMATTRS_HTTP_METHOD ||\n          key === SEMATTRS_HTTP_URL ||\n          key === SEMATTRS_HTTP_STATUS_CODE ||\n          key === SEMATTRS_HTTP_ROUTE ||\n          key === SEMATTRS_HTTP_HOST ||\n          key === SEMATTRS_HTTP_URL ||\n          key === SEMATTRS_DB_SYSTEM ||\n          key === SEMATTRS_DB_STATEMENT ||\n          key === SEMATTRS_DB_OPERATION ||\n          key === SEMATTRS_DB_NAME ||\n          key === SEMATTRS_RPC_SYSTEM ||\n          key === SEMATTRS_RPC_GRPC_STATUS_CODE ||\n          key === SEMATTRS_EXCEPTION_TYPE ||\n          key === SEMATTRS_EXCEPTION_MESSAGE ||\n          key === SEMATTRS_EXCEPTION_STACKTRACE\n        )\n      ) {\n        properties[key] = attributes[key] as string;\n      }\n    }\n  }\n  return properties;\n}\n\nfunction createPropertiesFromSpan(span: ReadableSpan): [Properties, Measurements] {\n  const properties: Properties = createPropertiesFromSpanAttributes(span.attributes);\n  const measurements: Measurements = {};\n\n  const links: MSLink[] = span.links.map((link: Link) => ({\n    operation_Id: link.context.traceId,\n    id: link.context.spanId,\n  }));\n  if (links.length > 0) {\n    properties[MS_LINKS] = JSON.stringify(links);\n  }\n  return [properties, measurements];\n}\n\nfunction createDependencyData(span: ReadableSpan): RemoteDependencyData {\n  const remoteDependencyData: RemoteDependencyData = {\n    name: span.name, // Default\n    id: `${span.spanContext().spanId}`,\n    success: span.status?.code !== SpanStatusCode.ERROR,\n    resultCode: \"0\",\n    type: \"Dependency\",\n    duration: msToTimeSpan(hrTimeToMilliseconds(span.duration)),\n    version: 2,\n  };\n  if (span.kind === SpanKind.PRODUCER) {\n    remoteDependencyData.type = DependencyTypes.QueueMessage;\n  }\n  if (span.kind === SpanKind.INTERNAL && span.parentSpanId) {\n    remoteDependencyData.type = DependencyTypes.InProc;\n  }\n\n  const httpMethod = span.attributes[SEMATTRS_HTTP_METHOD];\n  const dbSystem = span.attributes[SEMATTRS_DB_SYSTEM];\n  const rpcSystem = span.attributes[SEMATTRS_RPC_SYSTEM];\n  // HTTP Dependency\n  if (httpMethod) {\n    const httpUrl = span.attributes[SEMATTRS_HTTP_URL];\n    if (httpUrl) {\n      try {\n        const dependencyUrl = new URL(String(httpUrl));\n        remoteDependencyData.name = `${httpMethod} ${dependencyUrl.pathname}`;\n      } catch {\n        /* no-op */\n      }\n    }\n    remoteDependencyData.type = DependencyTypes.Http;\n    remoteDependencyData.data = getUrl(span.attributes);\n    const httpStatusCode = span.attributes[SEMATTRS_HTTP_STATUS_CODE];\n    if (httpStatusCode) {\n      remoteDependencyData.resultCode = String(httpStatusCode);\n    }\n    let target = getDependencyTarget(span.attributes);\n    if (target) {\n      try {\n        // Remove default port\n        const portRegex = new RegExp(/(https?)(:\\/\\/.*)(:\\d+)(\\S*)/);\n        const res = portRegex.exec(target);\n        if (res !== null) {\n          const protocol = res[1];\n          const port = res[3];\n          if (\n            (protocol === \"https\" && port === \":443\") ||\n            (protocol === \"http\" && port === \":80\")\n          ) {\n            // Drop port\n            target = res[1] + res[2] + res[4];\n          }\n        }\n      } catch {\n        /* no-op */\n      }\n      remoteDependencyData.target = `${target}`;\n    }\n  }\n  // DB Dependency\n  else if (dbSystem) {\n    // TODO: Remove special logic when Azure UX supports OpenTelemetry dbSystem\n    if (String(dbSystem) === DBSYSTEMVALUES_MYSQL) {\n      remoteDependencyData.type = \"mysql\";\n    } else if (String(dbSystem) === DBSYSTEMVALUES_POSTGRESQL) {\n      remoteDependencyData.type = \"postgresql\";\n    } else if (String(dbSystem) === DBSYSTEMVALUES_MONGODB) {\n      remoteDependencyData.type = \"mongodb\";\n    } else if (String(dbSystem) === DBSYSTEMVALUES_REDIS) {\n      remoteDependencyData.type = \"redis\";\n    } else if (isSqlDB(String(dbSystem))) {\n      remoteDependencyData.type = \"SQL\";\n    } else {\n      remoteDependencyData.type = String(dbSystem);\n    }\n    const dbStatement = span.attributes[SEMATTRS_DB_STATEMENT];\n    const dbOperation = span.attributes[SEMATTRS_DB_OPERATION];\n    if (dbStatement) {\n      remoteDependencyData.data = String(dbStatement);\n    } else if (dbOperation) {\n      remoteDependencyData.data = String(dbOperation);\n    }\n    const target = getDependencyTarget(span.attributes);\n    const dbName = span.attributes[SEMATTRS_DB_NAME];\n    if (target) {\n      remoteDependencyData.target = dbName ? `${target}|${dbName}` : `${target}`;\n    } else {\n      remoteDependencyData.target = dbName ? `${dbName}` : `${dbSystem}`;\n    }\n  }\n  // grpc Dependency\n  else if (rpcSystem) {\n    if (rpcSystem === DependencyTypes.Wcf) {\n      remoteDependencyData.type = DependencyTypes.Wcf;\n    } else {\n      remoteDependencyData.type = DependencyTypes.Grpc;\n    }\n    const grpcStatusCode = span.attributes[SEMATTRS_RPC_GRPC_STATUS_CODE];\n    if (grpcStatusCode) {\n      remoteDependencyData.resultCode = String(grpcStatusCode);\n    }\n    const target = getDependencyTarget(span.attributes);\n    if (target) {\n      remoteDependencyData.target = `${target}`;\n    } else if (rpcSystem) {\n      remoteDependencyData.target = String(rpcSystem);\n    }\n  }\n  return remoteDependencyData;\n}\n\nfunction createRequestData(span: ReadableSpan): RequestData {\n  const requestData: RequestData = {\n    id: `${span.spanContext().spanId}`,\n    success:\n      span.status.code !== SpanStatusCode.ERROR &&\n      (Number(span.attributes[SEMATTRS_HTTP_STATUS_CODE]) || 0) < 400,\n    responseCode: \"0\",\n    duration: msToTimeSpan(hrTimeToMilliseconds(span.duration)),\n    version: 2,\n    source: undefined,\n  };\n  const httpMethod = span.attributes[SEMATTRS_HTTP_METHOD];\n  const grpcStatusCode = span.attributes[SEMATTRS_RPC_GRPC_STATUS_CODE];\n  if (httpMethod) {\n    requestData.url = getUrl(span.attributes);\n    const httpStatusCode = span.attributes[SEMATTRS_HTTP_STATUS_CODE];\n    if (httpStatusCode) {\n      requestData.responseCode = String(httpStatusCode);\n    }\n  } else if (grpcStatusCode) {\n    requestData.responseCode = String(grpcStatusCode);\n  }\n  return requestData;\n}\n\n/**\n * Span to Azure envelope parsing.\n * @internal\n */\nexport function readableSpanToEnvelope(span: ReadableSpan, ikey: string): Envelope {\n  let name: string;\n  let baseType: \"RemoteDependencyData\" | \"RequestData\";\n  let baseData: RemoteDependencyData | RequestData;\n\n  const time = hrTimeToDate(span.startTime);\n  const instrumentationKey = ikey;\n  const tags = createTagsFromSpan(span);\n  const [properties, measurements] = createPropertiesFromSpan(span);\n  switch (span.kind) {\n    case SpanKind.CLIENT:\n    case SpanKind.PRODUCER:\n    case SpanKind.INTERNAL:\n      name = \"Microsoft.ApplicationInsights.RemoteDependency\";\n      baseType = \"RemoteDependencyData\";\n      baseData = createDependencyData(span);\n      break;\n    case SpanKind.SERVER:\n    case SpanKind.CONSUMER:\n      name = \"Microsoft.ApplicationInsights.Request\";\n      baseType = \"RequestData\";\n      baseData = createRequestData(span);\n      baseData.name = tags[KnownContextTagKeys.AiOperationName];\n      break;\n    default:\n      // never\n      diag.error(`Unsupported span kind ${span.kind}`);\n      throw new Error(`Unsupported span kind ${span.kind}`);\n  }\n\n  let sampleRate = 100;\n  if (span.attributes[AzureMonitorSampleRate]) {\n    sampleRate = Number(span.attributes[AzureMonitorSampleRate]);\n  }\n\n  // Azure SDK\n  if (span.attributes[AzNamespace]) {\n    if (span.kind === SpanKind.INTERNAL) {\n      baseData.type = `${DependencyTypes.InProc} | ${span.attributes[AzNamespace]}`;\n    }\n    if (span.attributes[AzNamespace] === MicrosoftEventHub) {\n      parseEventHubSpan(span, baseData);\n    }\n  }\n\n  return {\n    name,\n    sampleRate,\n    time,\n    instrumentationKey,\n    tags,\n    version: 1,\n    data: {\n      baseType,\n      baseData: {\n        ...baseData,\n        properties,\n        measurements,\n      },\n    },\n  };\n}\n\n/**\n * Span Events to Azure envelopes parsing.\n * @internal\n */\nexport function spanEventsToEnvelopes(span: ReadableSpan, ikey: string): Envelope[] {\n  const envelopes: Envelope[] = [];\n  if (span.events) {\n    span.events.forEach((event: TimedEvent) => {\n      let baseType: \"ExceptionData\" | \"MessageData\";\n      const time = hrTimeToDate(event.time);\n      let name = \"\";\n      let baseData: TelemetryExceptionData | MessageData;\n      const properties = createPropertiesFromSpanAttributes(event.attributes);\n\n      const tags: Tags = createTagsFromResource(span.resource);\n      tags[KnownContextTagKeys.AiOperationId] = span.spanContext().traceId;\n      const spanId = span.spanContext()?.spanId;\n      if (spanId) {\n        tags[KnownContextTagKeys.AiOperationParentId] = spanId;\n      }\n\n      // Only generate exception telemetry for incoming requests\n      if (event.name === \"exception\") {\n        if (span.kind === SpanKind.SERVER) {\n          name = \"Microsoft.ApplicationInsights.Exception\";\n          baseType = \"ExceptionData\";\n          let typeName = \"\";\n          let message = \"Exception\";\n          let stack = \"\";\n          let hasFullStack = false;\n          if (event.attributes) {\n            typeName = String(event.attributes[SEMATTRS_EXCEPTION_TYPE]);\n            stack = String(event.attributes[SEMATTRS_EXCEPTION_STACKTRACE]);\n            if (stack) {\n              hasFullStack = true;\n            }\n            const exceptionMsg = event.attributes[SEMATTRS_EXCEPTION_MESSAGE];\n            if (exceptionMsg) {\n              message = String(exceptionMsg);\n            }\n            const escaped = event.attributes[SEMATTRS_EXCEPTION_ESCAPED];\n            if (escaped !== undefined) {\n              properties[SEMATTRS_EXCEPTION_ESCAPED] = String(escaped);\n            }\n          }\n          const exceptionDetails: TelemetryExceptionDetails = {\n            typeName: typeName,\n            message: message,\n            stack: stack,\n            hasFullStack: hasFullStack,\n          };\n          const exceptionData: TelemetryExceptionData = {\n            exceptions: [exceptionDetails],\n            version: 2,\n            properties: properties,\n          };\n          baseData = exceptionData;\n        } else {\n          // Drop non-server exception span events\n          return;\n        }\n      } else {\n        name = \"Microsoft.ApplicationInsights.Message\";\n        baseType = \"MessageData\";\n        const messageData: MessageData = {\n          message: event.name,\n          version: 2,\n          properties: properties,\n        };\n        baseData = messageData;\n      }\n      let sampleRate = 100;\n      if (span.attributes[AzureMonitorSampleRate]) {\n        sampleRate = Number(span.attributes[AzureMonitorSampleRate]);\n      }\n      const env: Envelope = {\n        name: name,\n        time: time,\n        instrumentationKey: ikey,\n        version: 1,\n        sampleRate: sampleRate,\n        data: {\n          baseType: baseType,\n          baseData: baseData,\n        },\n        tags: tags,\n      };\n      envelopes.push(env);\n    });\n  }\n  return envelopes;\n}\n"]}